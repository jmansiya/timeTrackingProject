define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,t,i,n,a,o,r){function s(t,i,n){try{if(t.onError)try{t.onError(i,n)}catch(a){e.error(a)}else e.error(i)}finally{u(t,n,!0)}}function c(e){for(var t=[],i={childElements:t,activeView:null},n=r.virtualElements.firstChild(e);n;)1==n.nodeType&&(t.push(n),n.getAttribute(k)&&(i.activeView=n)),n=r.virtualElements.nextSibling(n);return i.activeView||(i.activeView=t[0]),i}function u(e,t,i){if(R--,0===R){var n=D;D=[],i||setTimeout(function(){for(var i=n.length;i--;)try{n[i]()}catch(a){s(e,a,t)}},1)}l(e)}function l(e){delete e.activeView,delete e.viewElements}function d(t,i,n,a){if(n)i();else if(t.activate&&t.model&&t.model.activate){var o;try{o=e.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData),o&&o.then?o.then(i,function(e){s(t,e,a),i()}):o||void 0===o?i():u(t,a)}catch(r){s(t,r,a)}}else i()}function f(t,i){var t=this;if(t.activeView&&t.activeView.removeAttribute(k),t.child)try{t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t),t.attached&&t.attached(t.child,t.parent,t),t.child.setAttribute(k,!0),t.composingNewView&&t.model&&t.model.detached&&r.utils.domNodeDisposal.addDisposeCallback(t.child,function(){try{t.model.detached(t.child,t.parent,t)}catch(e){s(t,e,i)}})}catch(n){s(t,n,i)}t.triggerAttach=e.noop}function v(t){if(e.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var i=t.activeView.getAttribute("data-view"),n=t.child.getAttribute("data-view");return i!=n}}return!0}return!1}function m(e){for(var t=0,i=e.length,n=[];i>t;t++){var a=e[t].cloneNode(!0);n.push(a)}return n}function h(t){var i=m(t.parts),n=y.getParts(i),a=y.getParts(t.child);for(var r in n){var s=a[r];s||(s=o('[data-part="'+r+'"]',t.child).get(0))?s.parentNode.replaceChild(n[r],s):e.log("Could not find part to override: "+r)}}function g(t){var i,n,a=r.virtualElements.childNodes(t.parent);if(!e.isArray(a)){var o=[];for(i=0,n=a.length;n>i;i++)o[i]=a[i];a=o}for(i=1,n=a.length;n>i;i++)r.removeNode(a[i])}function p(e){r.utils.domData.set(e,T,e.style.display),e.style.display="none"}function b(e){var t=r.utils.domData.get(e,T);e.style.display="none"===t?"block":t}function w(e){var t=e.getAttribute("data-bind");if(!t)return!1;for(var i=0,n=V.length;n>i;i++)if(t.indexOf(V[i])>-1)return!0;return!1}var y,A={},k="data-active-view",D=[],R=0,S="durandal-composition-data",I="data-part",E=["model","view","transition","area","strategy","activationData","onError"],T="durandal-visibility-data",V=["compose:"],C={complete:function(e){D.push(e)}};return y={composeBindings:V,convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:C,addBindingHandler:function(e,t,i){var n,a,o="composition-handler-"+e;t=t||r.bindingHandlers[e],i=i||function(){return void 0},a=r.bindingHandlers[e]={init:function(e,n,a,s,c){if(R>0){var u={trigger:r.observable(null)};y.current.complete(function(){t.init&&t.init(e,n,a,s,c),t.update&&(r.utils.domData.set(e,o,t),u.trigger("trigger"))}),r.utils.domData.set(e,o,u)}else r.utils.domData.set(e,o,t),t.init&&t.init(e,n,a,s,c);return i(e,n,a,s,c)},update:function(e,t,i,n,a){var s=r.utils.domData.get(e,o);return s.update?s.update(e,t,i,n,a):(s.trigger&&s.trigger(),void 0)}};for(n in t)"init"!==n&&"update"!==n&&(a[n]=t[n])},getParts:function(e,t){if(t=t||{},!e)return t;void 0===e.length&&(e=[e]);for(var i=0,n=e.length;n>i;i++){var a,o=e[i];o.getAttribute&&(a=o.getAttribute(I),a&&(t[a]=o),o.hasChildNodes()&&!w(o)&&y.getParts(o.childNodes,t))}return t},cloneNodes:m,finalize:function(t,n){if(void 0===t.transition&&(t.transition=this.defaultTransitionName),t.child||t.activeView)if(v(t)){var a=this.convertTransitionToModuleId(t.transition);e.acquire(a).then(function(e){t.transition=e,e(t).then(function(){if(t.cacheViews){if(t.activeView){var e=i.getBindingInstruction(t.activeView);e&&void 0!=e.cacheViews&&!e.cacheViews?r.removeNode(t.activeView):p(t.activeView)}}else t.child?g(t):r.virtualElements.emptyNode(t.parent);t.child&&b(t.child),t.triggerAttach(t,n),u(t,n)})}).fail(function(e){s(t,"Failed to load transition ("+a+"). Details: "+e.message,n)})}else{if(t.child!=t.activeView){if(t.cacheViews&&t.activeView){var o=i.getBindingInstruction(t.activeView);!o||void 0!=o.cacheViews&&!o.cacheViews?r.removeNode(t.activeView):p(t.activeView)}t.child?(t.cacheViews||g(t),b(t.child)):t.cacheViews||r.virtualElements.emptyNode(t.parent)}t.triggerAttach(t,n),u(t,n)}else t.cacheViews||r.virtualElements.emptyNode(t.parent),t.triggerAttach(t,n),u(t,n)},bindAndShow:function(e,t,a,o){a.child=e,a.parent.__composition_context=a,a.composingNewView=a.cacheViews?-1==r.utils.arrayIndexOf(a.viewElements,e):!0,d(a,function(){if(a.parent.__composition_context==a){if(delete a.parent.__composition_context,a.binding&&a.binding(a.child,a.parent,a),a.preserveContext&&a.bindingContext)a.composingNewView&&(a.parts&&h(a),p(e),r.virtualElements.prepend(a.parent,e),i.bindContext(a.bindingContext,e,a.model,a.as));else if(e){var o=a.model||A,s=r.dataFor(e);if(s!=o){if(!a.composingNewView)return r.removeNode(e),n.createView(e.getAttribute("data-view")).then(function(e){y.bindAndShow(e,t,a,!0)}),void 0;a.parts&&h(a),p(e),r.virtualElements.prepend(a.parent,e),i.bind(o,e)}}y.finalize(a,t)}else u(a,t)},o,t)},defaultStrategy:function(e){return t.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(t){var i,o=t(),s=r.utils.unwrapObservable(o)||{},c=a.isActivator(o);if(e.isString(s))return s=n.isViewUrl(s)?{view:s}:{model:s,activate:!c};if(i=e.getModuleId(s))return s={model:s,activate:!c};!c&&s.model&&(c=a.isActivator(s.model));for(var u in s)s[u]=-1!=r.utils.arrayIndexOf(E,u)?r.utils.unwrapObservable(s[u]):s[u];return c?s.activate=!1:void 0===s.activate&&(s.activate=!0),s},executeStrategy:function(e,t){e.strategy(e).then(function(i){y.bindAndShow(i,t,e)})},inject:function(i,n){return i.model?i.view?(t.locateView(i.view,i.area,i.viewElements).then(function(e){y.bindAndShow(e,n,i)}),void 0):(i.strategy||(i.strategy=this.defaultStrategy),e.isString(i.strategy)?e.acquire(i.strategy).then(function(e){i.strategy=e,y.executeStrategy(i,n)}).fail(function(e){s(i,"Failed to load view strategy ("+i.strategy+"). Details: "+e.message,n)}):this.executeStrategy(i,n),void 0):(this.bindAndShow(null,n,i),void 0)},compose:function(i,n,a,o){R++,o||(n=y.getSettings(function(){return n},i)),n.compositionComplete&&D.push(function(){n.compositionComplete(n.child,n.parent,n)}),D.push(function(){n.composingNewView&&n.model&&n.model.compositionComplete&&n.model.compositionComplete(n.child,n.parent,n)});var r=c(i);n.activeView=r.activeView,n.parent=i,n.triggerAttach=f,n.bindingContext=a,n.cacheViews&&!n.viewElements&&(n.viewElements=r.childElements),n.model?e.isString(n.model)?e.acquire(n.model).then(function(t){n.model=e.resolveObject(t),y.inject(n,i)}).fail(function(e){s(n,"Failed to load composed module ("+n.model+"). Details: "+e.message,i)}):y.inject(n,i):n.view?(n.area=n.area||"partial",n.preserveContext=!0,t.locateView(n.view,n.area,n.viewElements).then(function(e){y.bindAndShow(e,i,n)})):this.bindAndShow(null,i,n)}},r.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,i,a,o){var s=y.getSettings(t,e);if(s.mode){var c=r.utils.domData.get(e,S);if(!c){var u=r.virtualElements.childNodes(e);c={},"inline"===s.mode?c.view=n.ensureSingleElement(u):"templated"===s.mode&&(c.parts=m(u)),r.virtualElements.emptyNode(e),r.utils.domData.set(e,S,c)}"inline"===s.mode?s.view=c.view.cloneNode(!0):"templated"===s.mode&&(s.parts=c.parts),s.preserveContext=!0}y.compose(e,s,o,!0)}},r.virtualElements.allowedBindings.compose=!0,y});