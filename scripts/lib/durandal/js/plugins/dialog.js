define(["durandal/system","durandal/app","durandal/composition","durandal/activator","durandal/viewEngine","jquery","knockout"],function(e,t,i,n,o,a,r){function s(t){return e.defer(function(i){e.isString(t)?e.acquire(t).then(function(t){i.resolve(e.resolveObject(t))}).fail(function(i){e.error("Failed to load dialog module ("+t+"). Details: "+i.message)}):i.resolve(t)}).promise()}var c,l={},u=r.observable(0),d=function(e,t,i,n,o){this.message=e,this.title=t||d.defaultTitle,this.options=i||d.defaultOptions,this.autoclose=n||!1,this.settings=a.extend({},d.defaultSettings,o)};return d.prototype.selectOption=function(e){c.close(this,e)},d.prototype.getView=function(){return o.processMarkup(d.defaultViewMarkup)},d.setViewUrl=function(e){delete d.prototype.getView,d.prototype.viewUrl=e},d.defaultTitle=t.title||"Application",d.defaultOptions=["Ok"],d.defaultSettings={buttonClass:"btn btn-default",primaryButtonClass:"btn-primary autofocus",secondaryButtonClass:"","class":"modal-content messageBox",style:null},d.setDefaults=function(e){a.extend(d.defaultSettings,e)},d.prototype.getButtonClass=function(e){var t="";return this.settings&&(this.settings.buttonClass&&(t=this.settings.buttonClass),0===e()&&this.settings.primaryButtonClass&&(t.length>0&&(t+=" "),t+=this.settings.primaryButtonClass),e()>0&&this.settings.secondaryButtonClass&&(t.length>0&&(t+=" "),t+=this.settings.secondaryButtonClass)),t},d.prototype.getClass=function(){return this.settings?this.settings["class"]:"messageBox"},d.prototype.getStyle=function(){return this.settings?this.settings.style:null},d.prototype.getButtonText=function(t){var i=a.type(t);return"string"===i?t:"object"===i?"string"===a.type(t.text)?t.text:(e.error("The object for a MessageBox button does not have a text property that is a string."),null):(e.error("Object for a MessageBox button is not a string or object but "+i+"."),null)},d.prototype.getButtonValue=function(t){var i=a.type(t);return"string"===i?t:"object"===i?"undefined"===a.type(t.text)?(e.error("The object for a MessageBox button does not have a value property defined."),null):t.value:(e.error("Object for a MessageBox button is not a string or object but "+i+"."),null)},d.defaultViewMarkup=['<div data-view="plugins/messageBox" data-bind="css: getClass(), style: getStyle()">','<div class="modal-header">','<h3 data-bind="html: title"></h3>',"</div>",'<div class="modal-body">','<p class="message" data-bind="html: message"></p>',"</div>",'<div class="modal-footer">',"<!-- ko foreach: options -->",'<button data-bind="click: function () { $parent.selectOption($parent.getButtonValue($data)); }, text: $parent.getButtonText($data), css: $parent.getButtonClass($index)"></button>',"<!-- /ko -->",'<div style="clear:both;"></div>',"</div>","</div>"].join("\n"),c={MessageBox:d,currentZIndex:1050,getNextZIndex:function(){return++this.currentZIndex},isOpen:r.computed(function(){return u()>0}),getContext:function(e){return l[e||"default"]},addContext:function(e,t){t.name=e,l[e]=t;var i="show"+e.substr(0,1).toUpperCase()+e.substr(1);this[i]=function(t,i){return this.show(t,i,e)}},createCompositionSettings:function(e,t){var i={model:e,activate:!1,transition:!1};return t.binding&&(i.binding=t.binding),t.attached&&(i.attached=t.attached),t.compositionComplete&&(i.compositionComplete=t.compositionComplete),i},getDialog:function(e){return e?e.__dialog__:void 0},close:function(e){var t=this.getDialog(e);if(t){var i=Array.prototype.slice.call(arguments,1);t.close.apply(t,i)}},show:function(t,o,a){var r=this,c=l[a||"default"];return e.defer(function(e){s(t).then(function(t){var a=n.create();a.activateItem(t,o).then(function(n){if(n){var o=t.__dialog__={owner:t,context:c,activator:a,close:function(){var i=arguments;a.deactivateItem(t,!0).then(function(n){n&&(u(u()-1),c.removeHost(o),delete t.__dialog__,0===i.length?e.resolve():1===i.length?e.resolve(i[0]):e.resolve.apply(e,i))})}};o.settings=r.createCompositionSettings(t,c),c.addHost(o),u(u()+1),i.compose(o.host,o.settings)}else e.resolve(!1)})})}).promise()},showMessage:function(t,i,n,o,a){return e.isString(this.MessageBox)?c.show(this.MessageBox,[t,i||d.defaultTitle,n||d.defaultOptions,o||!1,a||{}]):c.show(new this.MessageBox(t,i,n,o,a))},install:function(e){t.showDialog=function(e,t,i){return c.show(e,t,i)},t.closeDialog=function(){return c.close.apply(c,arguments)},t.showMessage=function(e,t,i,n,o){return c.showMessage(e,t,i,n,o)},e.messageBox&&(c.MessageBox=e.messageBox),e.messageBoxView&&(c.MessageBox.prototype.getView=function(){return o.processMarkup(e.messageBoxView)}),e.messageBoxViewUrl&&c.MessageBox.setViewUrl(e.messageBoxViewUrl)}},c.addContext("default",{blockoutOpacity:.2,removeDelay:200,addHost:function(e){var t=a("body"),i=a('<div class="modalBlockout"></div>').css({"z-index":c.getNextZIndex(),opacity:this.blockoutOpacity}).appendTo(t),n=a('<div class="modalHost"></div>').css({"z-index":c.getNextZIndex()}).appendTo(t);if(e.host=n.get(0),e.blockout=i.get(0),!c.isOpen()){e.oldBodyMarginRight=t.css("margin-right"),e.oldInlineMarginRight=t.get(0).style.marginRight;var o=a("html"),r=t.outerWidth(!0),s=o.scrollTop();a("html").css("overflow-y","hidden");var l=a("body").outerWidth(!0);t.css("margin-right",l-r+parseInt(e.oldBodyMarginRight,10)+"px"),o.scrollTop(s)}},removeHost:function(e){if(a(e.host).css("opacity",0),a(e.blockout).css("opacity",0),setTimeout(function(){r.removeNode(e.host),r.removeNode(e.blockout)},this.removeDelay),!c.isOpen()){var t=a("html"),i=t.scrollTop();t.css("overflow-y","").scrollTop(i),e.oldInlineMarginRight?a("body").css("margin-right",e.oldBodyMarginRight):a("body").css("margin-right","")}},attached:function(e){a(e).css("visibility","hidden")},compositionComplete:function(e,t,i){var n=c.getDialog(i.model),o=a(e),r=o.find("img").filter(function(){var e=a(this);return!(this.style.width&&this.style.height||e.attr("width")&&e.attr("height"))});o.data("predefinedWidth",o.get(0).style.width);var s=function(e,t){setTimeout(function(){var i=a(e);t.context.reposition(e),a(t.host).css("opacity",1),i.css("visibility","visible"),i.find(".autofocus").first().focus()},1)};s(e,n),r.load(function(){s(e,n)}),(o.hasClass("autoclose")||i.model.autoclose)&&a(n.blockout).click(function(){n.close()})},reposition:function(e){var t=a(e),i=a(window);t.data("predefinedWidth")||t.css({width:""});var n=t.outerWidth(!1),o=t.outerHeight(!1),r=i.height()-10,s=i.width()-10,c=Math.min(o,r),l=Math.min(n,s);t.css({"margin-top":(-c/2).toString()+"px","margin-left":(-l/2).toString()+"px"}),o>r?t.css("overflow-y","auto").outerHeight(r):t.css({"overflow-y":"",height:""}),n>s?t.css("overflow-x","auto").outerWidth(s):(t.css("overflow-x",""),t.data("predefinedWidth")?t.css("width",t.data("predefinedWidth")):t.outerWidth(l))}}),c});