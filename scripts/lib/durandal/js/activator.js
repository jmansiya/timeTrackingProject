define(["durandal/system","knockout"],function(e,t){function n(t){return void 0==t&&(t={}),e.isBoolean(t.closeOnDeactivate)||(t.closeOnDeactivate=u.defaults.closeOnDeactivate),t.beforeActivate||(t.beforeActivate=u.defaults.beforeActivate),t.afterDeactivate||(t.afterDeactivate=u.defaults.afterDeactivate),t.affirmations||(t.affirmations=u.defaults.affirmations),t.interpretResponse||(t.interpretResponse=u.defaults.interpretResponse),t.areSameItem||(t.areSameItem=u.defaults.areSameItem),t.findChildActivator||(t.findChildActivator=u.defaults.findChildActivator),t}function i(t,n,i){return e.isArray(i)?t[n].apply(t,i):t[n](i)}function a(t,n,i,a,o){if(t&&t.deactivate){e.log("Deactivating",t);var r;try{r=t.deactivate(n)}catch(s){return e.log("ERROR: "+s.message,s),a.resolve(!1),void 0}r&&r.then?r.then(function(){i.afterDeactivate(t,n,o),a.resolve(!0)},function(t){e.log(t),a.resolve(!1)}):(i.afterDeactivate(t,n,o),a.resolve(!0))}else t&&i.afterDeactivate(t,n,o),a.resolve(!0)}function o(t,n,a,o){var r;if(t&&t.activate){e.log("Activating",t);try{r=i(t,"activate",o)}catch(s){return e.log("ERROR: "+s.message,s),a(!1),void 0}}r&&r.then?r.then(function(){n(t),a(!0)},function(t){e.log("ERROR: "+t.message,t),a(!1)}):(n(t),a(!0))}function r(t,n,i,a){return a=e.extend({},l,a),i.lifecycleData=null,e.defer(function(o){function r(){if(t&&t.canDeactivate&&a.canDeactivate){var r;try{r=t.canDeactivate(n)}catch(s){return e.log("ERROR: "+s.message,s),o.resolve(!1),void 0}r.then?r.then(function(e){i.lifecycleData=e,o.resolve(i.interpretResponse(e))},function(t){e.log("ERROR: "+t.message,t),o.resolve(!1)}):(i.lifecycleData=r,o.resolve(i.interpretResponse(r)))}else o.resolve(!0)}var s=i.findChildActivator(t);s?s.canDeactivate().then(function(e){e?r():o.resolve(!1)}):r()}).promise()}function s(t,n,a,o,r){return a.lifecycleData=null,e.defer(function(s){if(a.areSameItem(n(),t,o,r))return s.resolve(!0),void 0;if(t&&t.canActivate){var c;try{c=i(t,"canActivate",r)}catch(u){return e.log("ERROR: "+u.message,u),s.resolve(!1),void 0}c.then?c.then(function(e){a.lifecycleData=e,s.resolve(a.interpretResponse(e))},function(t){e.log("ERROR: "+t.message,t),s.resolve(!1)}):(a.lifecycleData=c,s.resolve(a.interpretResponse(c)))}else s.resolve(!0)}).promise()}function c(i,c){var u,l=t.observable(null);c=n(c);var d=t.computed({read:function(){return l()},write:function(e){d.viaSetter=!0,d.activateItem(e)}});return d.__activator__=!0,d.settings=c,c.activator=d,d.isActivating=t.observable(!1),d.forceActiveItem=function(e){l(e)},d.canDeactivateItem=function(e,t,n){return r(e,t,c,n)},d.deactivateItem=function(t,n){return e.defer(function(e){d.canDeactivateItem(t,n).then(function(i){i?a(t,n,c,e,l):(d.notifySubscribers(),e.resolve(!1))})}).promise()},d.canActivateItem=function(e,t){return s(e,l,c,u,t)},d.activateItem=function(t,n,i){var r=d.viaSetter;return d.viaSetter=!1,e.defer(function(s){if(d.isActivating())return s.resolve(!1),void 0;d.isActivating(!0);var f=l();return c.areSameItem(f,t,u,n)?(d.isActivating(!1),s.resolve(!0),void 0):(d.canDeactivateItem(f,c.closeOnDeactivate,i).then(function(i){i?d.canActivateItem(t,n).then(function(i){i?e.defer(function(e){a(f,c.closeOnDeactivate,c,e)}).promise().then(function(){t=c.beforeActivate(t,n),o(t,l,function(e){u=n,d.isActivating(!1),s.resolve(e)},n)}):(r&&d.notifySubscribers(),d.isActivating(!1),s.resolve(!1))}):(r&&d.notifySubscribers(),d.isActivating(!1),s.resolve(!1))}),void 0)}).promise()},d.canActivate=function(){var e;return i?(e=i,i=!1):e=d(),d.canActivateItem(e)},d.activate=function(){var e;return i?(e=i,i=!1):e=d(),d.activateItem(e)},d.canDeactivate=function(e){return d.canDeactivateItem(d(),e)},d.deactivate=function(e){return d.deactivateItem(d(),e)},d.includeIn=function(e){e.canActivate=function(){return d.canActivate()},e.activate=function(){return d.activate()},e.canDeactivate=function(e){return d.canDeactivate(e)},e.deactivate=function(e){return d.deactivate(e)}},c.includeIn?d.includeIn(c.includeIn):i&&d.activate(),d.forItems=function(t){c.closeOnDeactivate=!1,c.determineNextItemToActivate=function(e,t){var n=t-1;return-1==n&&e.length>1?e[1]:n>-1&&n<e.length-1?e[n]:null},c.beforeActivate=function(e){var n=d();if(e){var i=t.indexOf(e);-1==i?t.push(e):e=t()[i]}else e=c.determineNextItemToActivate(t,n?t.indexOf(n):0);return e},c.afterDeactivate=function(e,n){n&&t.remove(e)};var n=d.canDeactivate;d.canDeactivate=function(i){return i?e.defer(function(e){function n(){for(var t=0;t<o.length;t++)if(!o[t])return e.resolve(!1),void 0;e.resolve(!0)}for(var a=t(),o=[],r=0;r<a.length;r++)d.canDeactivateItem(a[r],i).then(function(e){o.push(e),o.length==a.length&&n()})}).promise():n()};var i=d.deactivate;return d.deactivate=function(n){return n?e.defer(function(e){function i(i){setTimeout(function(){d.deactivateItem(i,n).then(function(){o++,t.remove(i),o==r&&e.resolve()})},1)}for(var a=t(),o=0,r=a.length,s=0;r>s;s++)i(a[s])}).promise():i()},d},d}var u,l={canDeactivate:!0},d={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(n){return e.isObject(n)&&(n=n.can||!1),e.isString(n)?-1!==t.utils.arrayIndexOf(this.affirmations,n.toLowerCase()):n},areSameItem:function(e,t){return e==t},beforeActivate:function(e){return e},afterDeactivate:function(e,t,n){t&&n&&n(null)},findChildActivator:function(){return null}};return u={defaults:d,create:c,isActivator:function(e){return e&&e.__activator__}}});